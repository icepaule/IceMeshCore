# MeshCore Automations for Home Assistant
#
# Add these to your automations.yaml or create them via the HA UI.
#
# These automations use meshcore-ha's event system:
# - meshcore_raw_event: All raw MeshCore events (with event_type and payload)
# - meshcore_message_sent: Outgoing message confirmation
#
# Adjust entity_id values to match your actual MeshCore entities.

# =============================================================================
# Notify on incoming mesh messages (channel or direct)
# =============================================================================
- id: meshcore_message_notify
  alias: "MeshCore - New Message Notification"
  description: "Persistent notification for incoming mesh messages"
  trigger:
    - platform: event
      event_type: meshcore_raw_event
  condition:
    - condition: template
      value_template: "{{ trigger.event.data.event_type in ['CHANNEL_MSG', 'DIRECT_MSG'] }}"
  action:
    - service: persistent_notification.create
      data:
        title: "MeshCore Message"
        message: >
          {{ trigger.event.data.payload.get('text',
             trigger.event.data.payload | string) }}
        notification_id: "meshcore_{{ now().timestamp() | int }}"
  mode: queued
  max: 10

# =============================================================================
# Forward mesh messages to MQTT for external consumers
# =============================================================================
- id: meshcore_mqtt_bridge
  alias: "MeshCore - MQTT Bridge"
  description: "Publish mesh messages to MQTT topics"
  trigger:
    - platform: event
      event_type: meshcore_raw_event
  condition:
    - condition: template
      value_template: >
        {{ trigger.event.data.event_type in
           ['CHANNEL_MSG', 'DIRECT_MSG', 'NEW_CONTACT'] }}
  action:
    - service: mqtt.publish
      data:
        topic: "meshcore/{{ trigger.event.data.event_type | lower }}"
        payload: "{{ trigger.event.data.payload | tojson }}"
        retain: false
  mode: queued
  max: 20

# =============================================================================
# Alert when T-Beam battery drops below 20%
# =============================================================================
- id: meshcore_battery_low
  alias: "MeshCore - T-Beam Low Battery"
  description: "Warning when T-Beam battery is below 20%"
  trigger:
    - platform: numeric_state
      entity_id: sensor.meshcore_battery_percentage_t_beam
      below: 20
  action:
    - service: persistent_notification.create
      data:
        title: "MeshCore - Battery Low!"
        message: >
          T-Beam battery at
          {{ states('sensor.meshcore_battery_percentage_t_beam') }}%
        notification_id: meshcore_battery_low
  mode: single
